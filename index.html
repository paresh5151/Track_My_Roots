<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track My Roots — JNTUK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial
        }

        body {
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            color: #0f172a
        }

        .overlay {

            min-height: 100vh
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo {
            height: 72px;
            width: 72px;
            object-fit: contain
        }

        .search-row {
            display: flex;
            gap: 10px;
            position: relative;
            margin-top: 16px
        }

        .search-row input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1
        }

        .search-row button {
            padding: 11px 16px;
            border-radius: 8px;
            border: none;
            background: #0ea5a3;
            color: white;
            font-weight: 600;
            cursor: pointer
        }

        .suggestions {
            position: absolute;
            top: 48px;
            left: 0;
            right: 140px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 260px;
            overflow: auto;
            display: none;
            z-index: 50
        }

        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer
        }

        .suggestion-item:hover {
            background: #eef2ff
        }

        .main {
            display: flex;
            gap: 16px;
            margin-top: 18px
        }

        .map-panel {
            flex: 2;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06)
        }

        iframe#mapFrame {
            width: 100%;
            height: 420px;
            border: 0;
            border-radius: 8px;
            background: #efefef
        }

        .details {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04)
        }

        /* show full image (no cropping) */
        .plant-photo {
            width: 100%;
            height: auto;
            max-height: 360px;
            object-fit: contain;
            border-radius: 8px;
            display: none;
            background: #fff
        }

        .no-photo {
            width: 100%;
            height: 360px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: #64748b
        }

        .info-row {
            margin-top: 8px
        }

        .ref-block {
            margin-top: 12px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
            font-size: 15px;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .route-btn {
            padding: 8px 12px;
            background: #0ea5a3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600
        }

        @media (max-width:880px) {
            .main {
                flex-direction: column
            }

            iframe#mapFrame {
                height: 300px
            }

            .no-photo,
            .plant-photo {
                max-height: 260px
            }
        }
    </style>
</head>

<body>
    <div class="overlay">
        <div class="container">
            <div class="header">
                <img src="/images/logo.png" alt="logo" class="logo" />
                <div>
                    <h2 style="margin:0">JNTUK Kakinada — Track My Roots</h2>
                    <div style="color:#475569;font-size:13px">Digital Tree Tracking System</div>
                </div>
            </div>

            <div class="search-row" style="max-width:820px;">
                <input id="treeInput" placeholder="Enter Tree ID or Name" autocomplete="off" />
                <button id="locateBtn">Locate</button>
                <div id="suggestions" class="suggestions" role="listbox" aria-label="Search suggestions"></div>
            </div>

            <div class="main">
                <div class="map-panel">
                    <h3 style="margin:0 0 8px 0">Location Preview</h3>
                    <iframe id="mapFrame" title="map preview" src=""></iframe>
                </div>

                <aside class="details">
                    <h3 style="margin:0 0 8px 0">Plant Details</h3>

                    <!-- full-view image -->
                    <img id="plantPhoto" class="plant-photo" alt="plant photo" />
                    <div id="noPhoto" class="no-photo" style="display:none;">No photo available</div>

                    <div class="info-row"><strong>ID:</strong> <span id="infoId">—</span></div>
                    <div class="info-row"><strong>Name:</strong> <span id="infoName">—</span></div>
                    <div class="info-row"><strong>Planted Year:</strong> <span id="infoYear">—</span></div>
                    <div class="info-row"><strong>Maintained by:</strong> <span id="infoMaintainer">—</span></div>
                    <div class="info-row"><strong>Email:</strong> <span id="infoEmail">—</span></div>

                    <!-- simplified reference + route button -->
                    <div id="refBlock" class="ref-block" aria-hidden="true">
                        <span id="distanceOnly"></span>
                        <a id="routeBtn" class="route-btn" href="#" target="_blank" rel="noreferrer"
                            style="display:none;">Show route</a>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        /* PHOTO normalizer - supports full https URLs or filenames that map to /uploads/photos/ */
        function normalizePhotoField(raw) {
            if (raw === null || raw === undefined) return "";
            let s = String(raw).trim();
            if (!s) return "";
            // remove surrounding quotes
            if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) s = s.slice(1, -1).trim();
            // convert http to https to avoid mixed-content block
            if (/^http:\/\//i.test(s)) s = s.replace(/^http:\/\//i, 'https://');
            if (/^https?:\/\//i.test(s)) return s;
            if (s.startsWith('/')) return s;
            // otherwise assume filename
            return '/uploads/photos/' + s.replace(/^\/+/, '');
        }

        function normalizeKey(k) { return String(k || "").trim().toLowerCase().replace(/\s+/g, '_'); }

        function parseReferencePointField(s) {
            if (!s) return null;
            s = String(s).trim();
            // quick decimal pair e.g. "16.97970,82.24267"
            if (s.indexOf(',') !== -1) {
                const parts = s.split(',');
                if (parts.length >= 2) {
                    const a = parseFloat(parts[0].replace(/[^\d\.\-]/g, '')), b = parseFloat(parts[1].replace(/[^\d\.\-]/g, ''));
                    if (!isNaN(a) && !isNaN(b)) return { lat: a, lng: b };
                }
            }
            // fallback: extract first two numbers
            const nums = s.match(/-?\d+(\.\d+)?/g);
            if (nums && nums.length >= 2) return { lat: parseFloat(nums[0]), lng: parseFloat(nums[1]) };
            return null;
        }

        function haversineDistanceMeters(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            lat1 = Number(lat1); lon1 = Number(lon1); lat2 = Number(lat2); lon2 = Number(lon2);
            if ([lat1, lon1, lat2, lon2].some(x => isNaN(x))) return null;
            const R = 6371000, toRad = d => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        let PLANTS = [];
        let SUGGESTIONS = [];

        /* Load trees.csv (use cache-buster trick if you need to force refresh) */
        Papa.parse("trees.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (res) {
                const rows = res.data || [];
                PLANTS = rows.map(row => {
                    const norm = {};
                    for (let k in row) norm[normalizeKey(k)] = row[k];
                    // coordinates
                    let lat = norm.gps_coordinate || norm.gps || norm.coords || norm.lat || "";
                    let lng = norm.lng || norm.longitude || "";
                    if ((!lng || !lat) && lat && String(lat).indexOf(',') !== -1) {
                        const p = String(lat).split(',');
                        if (p.length >= 2) { lat = p[0].trim(); lng = p[1].trim(); }
                    }
                    const ref = parseReferencePointField(norm.reference_point || norm['reference point'] || norm.reference || '');
                    const photo = normalizePhotoField(norm.photo || norm.photo_url || norm.image || '');
                    const id = (norm.tree_id || norm.id || '').toString().trim();
                    const name = (norm.tree_name || norm.name || '').toString().trim();
                    return {
                        id, name, lat, lng, photo,
                        planted_year: norm.planted_year || norm.year || '',
                        maintainer: { name: norm.maintained_by || norm.maintainer || '', email: norm.email_id || norm.email || '' },
                        reference: { name: norm.department_name || norm.department || '', lat: ref ? ref.lat : '', lng: ref ? ref.lng : '' }
                    };
                });

                SUGGESTIONS = PLANTS.map(p => ({ label: (p.id ? ('[' + p.id + '] ': '') + p.name : p.name), lower: ((p.id || '') + ' ' + (p.name || '')).toLowerCase(), id: p.id, name: p.name }));
        console.log('Loaded', PLANTS.length, 'rows');
  }
});

        /* Suggestions UI */
        const inputEl = document.getElementById('treeInput');
        const suggestionsEl = document.getElementById('suggestions');

        function showSuggestions(q) {
            q = String(q || '').trim().toLowerCase();
            if (!q) { suggestionsEl.style.display = 'none'; return; }
            const results = SUGGESTIONS.filter(s => s.lower.indexOf(q) !== -1).slice(0, 20);
            if (results.length === 0) { suggestionsEl.style.display = 'none'; return; }
            suggestionsEl.innerHTML = results.map((r, i) => `<div class="suggestion-item" data-i="${i}">${r.label}</div>`).join('');
            suggestionsEl.style.display = 'block';
        }

        inputEl.addEventListener('input', () => showSuggestions(inputEl.value));
        document.addEventListener('click', (e) => {
            const sel = e.target.closest('.suggestion-item');
            if (sel) {
                const i = Number(sel.getAttribute('data-i'));
                const s = SUGGESTIONS[i];
                inputEl.value = s.id || s.name || '';
                suggestionsEl.style.display = 'none';
                lookupTree();
            } else if (!e.target.closest('.search-row')) suggestionsEl.style.display = 'none';
        });

        /* Lookup & show */
        document.getElementById('locateBtn').addEventListener('click', lookupTree);
        inputEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); lookupTree(); } });

        function lookupTree() {
            const q = String(inputEl.value || '').trim().toLowerCase();
            if (!q) { alert('Enter Tree ID or Name'); return; }
            const rec = PLANTS.find(r => (r.id || '').toLowerCase() === q) ||
                PLANTS.find(r => (r.name || '').toLowerCase() === q) ||
                PLANTS.find(r => (r.name || '').toLowerCase().includes(q)) ||
                PLANTS.find(r => (r.id || '').toLowerCase().includes(q));
            if (!rec) { alert('Tree not found'); return; }
            showRecord(rec);
        }

        function showRecord(record) {
            // map embed
            if (record.lat && record.lng) {
                document.getElementById('mapFrame').src = `https://www.google.com/maps?q=${record.lat},${record.lng}&z=18&output=embed`;
            } else {
                document.getElementById('mapFrame').src = '';
            }

            // info
            document.getElementById('infoId').textContent = record.id || '—';
            document.getElementById('infoName').textContent = record.name || '—';
            document.getElementById('infoYear').textContent = record.planted_year || '—';
            document.getElementById('infoMaintainer').textContent = record.maintainer?.name || '—';
            document.getElementById('infoEmail').textContent = record.maintainer?.email || '—';

            // photo (full display)
            const img = document.getElementById('plantPhoto');
            const no = document.getElementById('noPhoto');
            console.log('DEBUG: showRecord photo ->', record.photo);
            if (record.photo && record.photo.trim() !== '') {
                img.onerror = function () { console.error('IMAGE FAILED ->', record.photo); img.style.display = 'none'; no.style.display = 'flex'; };
                img.onload = function () { img.style.display = 'block'; no.style.display = 'none'; };
                img.src = record.photo;
            } else {
                img.src = '';
                img.style.display = 'none';
                no.style.display = 'flex';
            }

            // reference + route
            const refBlock = document.getElementById('refBlock');
            const distEl = document.getElementById('distanceOnly');
            const routeBtn = document.getElementById('routeBtn');

            if (record.reference && record.reference.name && record.reference.lat && record.reference.lng) {
                const d = haversineDistanceMeters(record.lat, record.lng, record.reference.lat, record.reference.lng);
                const distText = d === null ? 'unknown distance' : (d < 1000 ? `${Math.round(d)} m` : `${(d / 1000).toFixed(2)} km`);
                distEl.textContent = `Located ${distText} from ${record.reference.name}`;
                // create Google Maps directions URL (origin = reference, destination = tree)
                const origin = `${record.reference.lat},${record.reference.lng}`;
                const destination = `${record.lat},${record.lng}`;
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=walking`;
                routeBtn.href = mapsUrl;
                routeBtn.style.display = 'inline-block';
                refBlock.style.display = 'flex';
            } else {
                refBlock.style.display = 'none';
                routeBtn.style.display = 'none';
            }
        }
    </script>
</body>

</html>