<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track My Roots — JNTUK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial
        }

        body {
            background-image: url('/images/background.ppg');
            background-size: cover;
            background-position: center;
            color: #0f172a
        }

        .overlay {
            min-height: 100vh
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo {
            height: 72px;
            width: 72px;
            object-fit: contain
        }

        .search-row {
            display: flex;
            gap: 10px;
            position: relative;
            margin-top: 16px
        }

        .search-row input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1
        }

        .search-row button {
            padding: 11px 16px;
            border-radius: 8px;
            border: none;
            background: #0ea5a3;
            color: white;
            font-weight: 600;
            cursor: pointer
        }

        .suggestions {
            position: absolute;
            top: 48px;
            left: 0;
            right: 140px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 260px;
            overflow: auto;
            display: none;
            z-index: 50
        }

        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer
        }

        .suggestion-item:hover {
            background: #eef2ff
        }

        .main {
            display: flex;
            gap: 16px;
            margin-top: 18px
        }

        .map-panel {
            flex: 2;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06)
        }

        iframe#mapFrame {
            width: 100%;
            height: 420px;
            border: 0;
            border-radius: 8px;
            background: #efefef
        }

        .details {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04)
        }

        .plant-photo {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 8px;
            display: none
        }

        .no-photo {
            width: 100%;
            height: 220px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: #64748b
        }

        .ref-block {
            margin-top: 12px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
            font-size: 15px;
            font-weight: 600;
            color: #0f172a
        }

        @media (max-width:880px) {
            .main {
                flex-direction: column
            }

            iframe#mapFrame {
                height: 300px
            }
        }
    </style>
</head>

<body>
    <div class="overlay">
        <div class="container">
            <div class="header">
                <img src="/images/logo.png" alt="logo" class="logo" />
                <div>
                    <h2 style="margin:0">JNTUK Kakinada — Track My Roots</h2>
                    <div style="color:#475569;font-size:13px">Digital Tree Tracking System</div>
                </div>
            </div>

            <div class="search-row" style="max-width:820px;">
                <input id="treeInput" placeholder="Enter Tree ID or Name" autocomplete="off" />
                <button id="locateBtn">Locate</button>
                <div id="suggestions" class="suggestions" role="listbox" aria-label="Search suggestions"></div>
            </div>

            <div class="main">
                <div class="map-panel">
                    <h3 style="margin:0 0 8px 0">Location Preview</h3>
                    <iframe id="mapFrame" title="map preview" src=""></iframe>
                </div>

                <aside class="details">
                    <h3 style="margin:0">Plant Details</h3>
                    <img id="plantPhoto" class="plant-photo" src="" alt="plant" />
                    <div id="noPhoto" class="no-photo" style="display:none;">No photo available</div>

                    <div style="margin-top:10px"><strong>ID:</strong> <span id="infoId">—</span></div>
                    <div style="margin-top:8px"><strong>Name:</strong> <span id="infoName">—</span></div>
                    <div style="margin-top:8px"><strong>Planted Year:</strong> <span id="infoYear">—</span></div>
                    <div style="margin-top:8px"><strong>Maintained by:</strong> <span id="infoMaintainer">—</span></div>
                    <div style="margin-top:8px"><strong>Email:</strong> <span id="infoEmail">—</span></div>

                    <div id="refBlock" class="ref-block"><span id="distanceOnly"></span></div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        /* === PHOTO NORMALIZER (Section C) === */
        function normalizePhotoField(raw) {
            if (raw === null || raw === undefined) return "";
            let s = String(raw).trim();
            if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) s = s.slice(1, -1).trim();
            if (!s) return "";
            if (/^https?:\/\//i.test(s)) { if (s.startsWith('http://')) s = s.replace(/^http:\/\//i, 'https://'); return s; }
            if (s.startsWith('/')) return s;
            return '/uploads/photos/' + s.replace(/^\/*/, '');
        }

        function normalizeKey(k) { return String(k || "").trim().toLowerCase().replace(/\s+/g, '_'); }

        function dmsPartToDecimal(part) {
            if (!part) return null; part = String(part).trim();
            part = part.replace(/°/g, ' ').replace(/'/g, ' ').replace(/"/g, ' ').replace(/,/g, ' ');
            const m = part.match(/([0-9]+(?:\.[0-9]+)?)\s+([0-9]+(?:\.[0-9]+)?)?\s*([0-9]+(?:\.[0-9]+)?)?\s*([NSEWnsew])?/);
            if (!m) { const num = parseFloat(part); if (!isNaN(num)) return num; return null; }
            const deg = parseFloat(m[1] || 0), min = parseFloat(m[2] || 0), sec = parseFloat(m[3] || 0);
            let dec = Math.abs(deg) + (min / 60) + (sec / 3600); const dir = (m[4] || '').toUpperCase();
            if (dir === 'S' || dir === 'W') dec = -dec; if (String(m[1]).trim().startsWith('-')) dec = -dec; return dec;
        }

        function parseReferencePointField(s) { if (!s) return null; s = String(s).trim(); if (s.indexOf(',') !== -1 && /[0-9]/.test(s)) { const parts = s.split(','); if (parts.length >= 2) { const a = parseFloat(parts[0].replace(/[^\d\.\-]/g, '')); const b = parseFloat(parts[1].replace(/[^\d\.\-]/g, '')); if (!isNaN(a) && !isNaN(b)) return { lat: a, lng: b }; } } const idx = s.search(/[NnSs]/); if (idx !== -1) { const ew = s.slice(idx + 1).search(/[EeWw]/); if (ew !== -1) { const first = s.slice(0, idx + 1).trim(); const second = s.slice(idx + 1).trim(); const lat = dmsPartToDecimal(first); const lng = dmsPartToDecimal(second); if (lat !== null && lng !== null) return { lat, lng }; } else { const tokens = s.split(/\s+/); if (tokens.length >= 2) { const part1 = tokens.slice(0, Math.ceil(tokens.length / 2)).join(' '); const part2 = tokens.slice(Math.ceil(tokens.length / 2)).join(' '); const lat = dmsPartToDecimal(part1); const lng = dmsPartToDecimal(part2); if (lat !== null && lng !== null) return { lat, lng }; } } } const nums = s.match(/-?\d+(?:\.\d+)?/g); if (nums && nums.length >= 2) { return { lat: parseFloat(nums[0]), lng: parseFloat(nums[1]) }; } return null; }

        function haversineDistanceMeters(lat1, lon1, lat2, lon2) { if (!lat1 || !lon1 || !lat2 || !lon2) return null; const toNum = v => Number(String(v).trim()); lat1 = toNum(lat1); lon1 = toNum(lon1); lat2 = toNum(lat2); lon2 = toNum(lon2); if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return null; const R = 6371000; const toRad = deg => deg * Math.PI / 180; const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1); const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }

        let PLANTS = [];
        let SUGGESTIONS = [];

        Papa.parse("trees.csv", {
            download: true, header: true, skipEmptyLines: true, complete: function (res) {
                // Note: if your CSV/Excel is named differently, change this path to trees.csv or plants.csv
                const rows = res.data || [];
                PLANTS = rows.map(row => {
                    const norm = {};
                    for (let k in row) norm[normalizeKey(k)] = row[k];
                    // get lat/lng
                    let lat = norm.gps_coordinate || norm.gps || norm.coords || norm.lat || "";
                    let lng = norm.lng || norm.longitude || "";
                    if ((!lat || !lng) && lat && lat.indexOf(",") !== -1) { const p = String(lat).split(","); if (p.length >= 2) { lat = p[0].trim(); lng = p[1].trim(); } }
                    const refCoords = parseReferencePointField(norm.reference_point || norm['reference point'] || norm.reference || '');
                    const photoRaw = norm.photo || norm.photo_url || norm.image || norm['photo '] || '';
                    const photo = normalizePhotoField(photoRaw);
                    const id = (norm.tree_id || norm.id || '').toString().trim();
                    const name = (norm.tree_name || norm.name || '').toString().trim();
                    return {
                        id, name, lat, lng, photo,
                        planted_year: norm.planted_year || norm.year || '',
                        maintainer: { name: norm.maintained_by || norm.maintainer || '', email: norm.email_id || norm.email || '' },
                        reference: { name: norm.department_name || norm.department || '', lat: refCoords ? refCoords.lat : '', lng: refCoords ? refCoords.lng : '' }
                    };
                });

                SUGGESTIONS = PLANTS.map((p, i) => ({ label: (p.id ? ('[' + p.id + '] ': '') + p.name, id: p.id, name: p.name, lower: (((p.id || '') + ' ' + (p.name || '')).toLowerCase()) }));
                console.log('Loaded', PLANTS.length, 'rows');
            }
        });

        const inputEl = document.getElementById('treeInput');
        const suggestionsEl = document.getElementById('suggestions');

        function escapeHtml(s) { return String(s).replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[m]; }); }

        function showSuggestions(query) { const q = String(query || '').trim().toLowerCase(); if (!q) { suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML = ''; return; } const results = SUGGESTIONS.filter(s => s.lower.indexOf(q) !== -1).slice(0, 20); if (results.length === 0) { suggestionsEl.style.display = 'none'; return; } suggestionsEl.innerHTML = results.map((r, idx) => `<div class="suggestion-item" data-idx="${idx}">${escapeHtml(r.label)}</div>`).join(''); suggestionsEl.style.display = 'block'; }

        suggestionsEl.addEventListener('click', function (e) { const item = e.target.closest('.suggestion-item'); if (!item) return; const idx = Number(item.getAttribute('data-idx')); const sel = SUGGESTIONS[idx]; if (!sel) return; inputEl.value = sel.id || sel.name || ''; suggestionsEl.style.display = 'none'; lookupTree(); });

        let debounceTimer = null; inputEl.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => showSuggestions(inputEl.value), 120); });
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-row')) suggestionsEl.style.display = 'none'; });

        function qrImageUrl(payload, size = 300) { const chs = size + 'x' + size; const chl = encodeURIComponent(payload); return `https://chart.googleapis.com/chart?chs=${chs}&cht=qr&chl=${chl}`; }

        function lookupTree() {
            const q = (inputEl.value || '').trim().toLowerCase(); if (!q) { alert('Enter a Tree ID or Name'); return; }
            let rec = PLANTS.find(r => (r.id || '').toLowerCase() === q) || PLANTS.find(r => (r.name || '').toLowerCase() === q) || PLANTS.find(r => (r.name || '').toLowerCase().includes(q)) || PLANTS.find(r => (r.id || '').toLowerCase().includes(q));
            if (!rec) { alert('No matching record found.'); clearDisplay(); return; }
            showRecord(rec);
        }

        function clearDisplay() { document.getElementById('mapFrame').src = ''; const img = document.getElementById('plantPhoto'); img.src = ''; img.style.display = 'none'; document.getElementById('noPhoto').style.display = 'none'; document.getElementById('infoId').textContent = '—'; document.getElementById('infoName').textContent = '—'; document.getElementById('infoYear').textContent = '—'; document.getElementById('infoMaintainer').textContent = '—'; document.getElementById('infoEmail').textContent = '—'; document.getElementById('refBlock').style.display = 'none'; }

        function showRecord(record) {
            if (record.lat && record.lng) document.getElementById('mapFrame').src = `https://www.google.com/maps?q=${record.lat},${record.lng}&z=18&output=embed`; else document.getElementById('mapFrame').src = '';
            document.getElementById('infoId').textContent = record.id || '—'; document.getElementById('infoName').textContent = record.name || '—'; document.getElementById('infoYear').textContent = record.planted_year || '—'; document.getElementById('infoMaintainer').textContent = record.maintainer?.name || '—'; document.getElementById('infoEmail').textContent = record.maintainer?.email || '—';

            const img = document.getElementById('plantPhoto'); const noPhoto = document.getElementById('noPhoto');
            console.log('DEBUG: showRecord photo ->', record.photo);
            if (record.photo && record.photo.trim() !== '') {
                img.onerror = function () { console.error('IMAGE FAILED ->', record.photo); img.style.display = 'none'; noPhoto.style.display = 'flex'; };
                img.onload = function () { img.style.display = 'block'; noPhoto.style.display = 'none'; };
                img.src = record.photo;
            } else { img.src = ''; img.style.display = 'none'; noPhoto.style.display = 'flex'; }

            if (record.reference && record.reference.name && record.reference.lat && record.reference.lng) { const d = haversineDistanceMeters(record.lat, record.lng, record.reference.lat, record.reference.lng); const distText = d === null ? 'unknown distance' : (d < 1000 ? `${Math.round(d)} m` : `${(d / 1000).toFixed(2)} km`); document.getElementById('distanceOnly').textContent = `Located ${distText} from ${record.reference.name}`; document.getElementById('refBlock').style.display = 'block'; } else { document.getElementById('refBlock').style.display = 'none'; }
        }

        document.getElementById('locateBtn').addEventListener('click', lookupTree);
        inputEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); lookupTree(); } });
    </script>
</body>

</html>