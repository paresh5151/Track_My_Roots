<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track My Roots — JNTUK</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background-image: url('/images/background.png');
            background-size: cover;
            background-position: center;
            color: #0f172a;
        }

        .page-overlay {
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 25px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 70px;
            width: 70px;
            object-fit: contain;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            position: relative;
        }

        .search-row input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .search-row button {
            padding: 12px 20px;
            background: #0ea5a3;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
        }

        .suggestions {
            position: absolute;
            top: 50px;
            left: 0;
            right: 160px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background: #eef2ff;
        }

        .main {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .map-panel,
        .details-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 8px;
        }

        .plant-photo {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 8px;
            display: none;
        }

        .no-photo {
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 8px;
            display: none;
        }

        /* New simplified reference block */
        .ref-block {
            margin-top: 12px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
            font-size: 15px;
            font-weight: 600;
            color: #0f172a;
        }
    </style>
</head>

<body>
    <div class="page-overlay">
        <div class="container">

            <!-- Header -->
            <div class="header">
                <img src="/images/logo.png" class="logo" />
                <div>
                    <h2>JNTUK Kakinada — Track My Roots</h2>
                    <div style="color:#475569; font-size:14px;">Digital Tree Tracking System</div>
                </div>
            </div>

            <!-- Search -->
            <div class="search-row">
                <input id="treeInput" placeholder="Search by Tree ID or Name" autocomplete="off" />
                <button id="locateBtn">Locate</button>
                <div id="suggestions" class="suggestions"></div>
            </div>

            <!-- Panels -->
            <div class="main">
                <div class="map-panel">
                    <h3>Location Preview</h3>
                    <iframe id="mapFrame"></iframe>
                </div>

                <div class="details-panel">
                    <h3>Plant Details</h3>

                    <img id="plantPhoto" class="plant-photo" />
                    <div id="noPhoto" class="no-photo">No photo available</div>

                    <div style="margin-top:10px;">
                        <strong>ID:</strong> <span id="infoId">—</span>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Name:</strong> <span id="infoName">—</span>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Planted Year:</strong> <span id="infoYear">—</span>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Maintained by:</strong> <span id="infoMaintainer">—</span>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Email:</strong> <span id="infoEmail">—</span>
                    </div>

                    <!-- NEW simplified reference block -->
                    <div id="refBlock" class="ref-block">
                        <span id="distanceOnly"></span>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        function normalizeKey(k) {
            return String(k || "").trim().toLowerCase().replace(/\s+/g, "_");
        }

        /* DMS → decimal converter (simplified) */
        function dmsToDecimal(str) {
            if (!str) return null;
            str = str.replace(/[^\d.,NSEW°'"]/g, " ").trim();

            // try decimal
            if (str.includes(",")) {
                let parts = str.split(",");
                if (parts.length >= 2) {
                    let a = parseFloat(parts[0]); let b = parseFloat(parts[1]);
                    if (!isNaN(a) && !isNaN(b)) return { lat: a, lng: b };
                }
            }

            // fallback: extract numbers
            let nums = str.match(/-?\d+(\.\d+)?/g);
            if (nums && nums.length >= 2) {
                return { lat: parseFloat(nums[0]), lng: parseFloat(nums[1]) };
            }
            return null;
        }

        /* Distance formula */
        function haversine(lat1, lon1, lat2, lon2) {
            let R = 6371000;
            lat1 *= Math.PI / 180; lon1 *= Math.PI / 180;
            lat2 *= Math.PI / 180; lon2 *= Math.PI / 180;
            let dLat = lat2 - lat1, dLon = lon2 - lon1;
            let a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        let PLANTS = [];
        let SUGGESTIONS = [];

        /* Load the CSV */
        Papa.parse("trees.csv", {
            download: true,
            header: true,
            complete: function (res) {
                PLANTS = res.data.map(row => {
                    let norm = {};
                    for (let k in row) norm[normalizeKey(k)] = row[k];

                    let gps = norm.gps_coordinate || "";
                    let lat = "", lng = "";
                    if (gps.includes(",")) {
                        let p = gps.split(",");
                        lat = p[0]; lng = p[1];
                    }

                    let ref = dmsToDecimal(norm.reference_point);
                    return {
                        id: norm.tree_id || norm.id || "",
                        name: norm.tree_name || norm.name || "",
                        lat, lng,
                        photo: norm.photo,
                        planted_year: norm.planted_year || "",
                        maintained_by: norm.maintained_by || "",
                        email: norm.email || "",
                        refName: norm.department_name || "",
                        refLat: ref ? ref.lat : "",
                        refLng: ref ? ref.lng : ""
                    };
                });

                SUGGESTIONS = PLANTS.map(p => ({
                    label: (p.id ? "[" + p.id + "] " : "") + p.name,
                    search: ((p.id || "") + " " + (p.name || "")).toLowerCase(),
                    id: p.id
                }));
            }
        });

        /* Suggestions */
        const input = document.getElementById("treeInput");
        const sugBox = document.getElementById("suggestions");

        input.addEventListener("input", () => {
            let q = input.value.toLowerCase().trim();
            if (!q) { sugBox.style.display = "none"; return; }

            let results = SUGGESTIONS.filter(s => s.search.includes(q)).slice(0, 20);

            if (results.length === 0) { sugBox.style.display = "none"; return; }

            sugBox.innerHTML = results.map(r => <div class="suggestion-item" data-id="${r.id}">${r.label}</div>).join("");
            sugBox.style.display = "block";
        });

        sugBox.addEventListener("click", (e) => {
            if (!e.target.dataset.id) return;
            input.value = e.target.dataset.id;
            sugBox.style.display = "none";
            lookup();
        });

        /* Main lookup */
        function lookup() {
            let q = input.value.toLowerCase().trim();
            let rec = PLANTS.find(p => p.id.toLowerCase() === q) ||
                PLANTS.find(p => p.name.toLowerCase() === q) ||
                PLANTS.find(p => p.name.toLowerCase().includes(q));

            if (!rec) { alert("Not found"); return; }

            // Map
            if (rec.lat && rec.lng) {
                document.getElementById("mapFrame").src =
                    https://www.google.com/maps?q=${rec.lat},${rec.lng}&z=18&output=embed;
            }

            // Photo
            let img = document.getElementById("plantPhoto");
            let no = document.getElementById("noPhoto");
            if (rec.photo) {
                img.src = rec.photo;
                img.style.display = "block";
                no.style.display = "none";
            } else {
                img.style.display = "none";
                no.style.display = "flex";
            }

            document.getElementById("infoId").textContent = rec.id;
            document.getElementById("infoName").textContent = rec.name;
            document.getElementById("infoYear").textContent = rec.planted_year;
            document.getElementById("infoMaintainer").textContent = rec.maintained_by;
            document.getElementById("infoEmail").textContent = rec.email;

            /* NEW simplified reference sentence */
            let refBox = document.getElementById("refBlock");
            let dist = document.getElementById("distanceOnly");

            if (rec.refName && rec.refLat && rec.refLng) {
                let d = haversine(rec.lat, rec.lng, rec.refLat, rec.refLng);
                let dStr = d < 1000 ? ${ Math.round(d)
            } m: ${ (d / 1000).toFixed(2) } km;

            dist.textContent = Located ${ dStr } from ${ rec.refName };
            refBox.style.display = "block";
        } else {
            refBox.style.display = "none";
        }
        }

        document.getElementById("locateBtn").onclick = lookup;
        input.addEventListener("keydown", e => {
            if (e.key === "Enter") lookup();
        });
    </script>
</body>
</html>