<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track My Roots — JNTUK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial
        }

        body {
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            color: #0f172a;
        }

        .page-overlay {
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.90)
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 24px
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo {
            height: 72px;
            width: 72px;
            object-fit: contain
        }

        .search-row {
            display: flex;
            gap: 10px;
            position: relative;
            margin-top: 14px
        }

        .search-row input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1
        }

        .search-row button {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background: #0ea5a3;
            color: #fff;
            font-weight: 600;
            cursor: pointer
        }

        .suggestions {
            position: absolute;
            top: 48px;
            left: 0;
            right: 140px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 260px;
            overflow: auto;
            display: none;
            z-index: 50
        }

        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer
        }

        .suggestion-item:hover {
            background: #eef2ff
        }

        .main {
            display: flex;
            gap: 16px;
            margin-top: 18px
        }

        .map-panel {
            flex: 2;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06)
        }

        iframe#mapFrame {
            width: 100%;
            height: 420px;
            border: 0;
            border-radius: 8px;
            background: #efefef
        }

        .details {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.04)
        }

        .info-row {
            margin-top: 10px
        }

        /* square photo container, image fully visible */
        .photo-wrap {
            width: 100%;
            aspect-ratio: 1/1;
            /* keeps it square */
            max-height: 420px;
            /* limits on tall screens */
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-wrap img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* show whole image, no crop */
            display: block;
        }

        .no-photo {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: #64748b
        }

        .ref-block {
            margin-top: 12px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
            font-size: 15px;
            font-weight: 600;
            color: #0f172a;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            display: flex;
        }

        .route-btn {
            padding: 8px 12px;
            background: #0ea5a3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600
        }

        @media (max-width:880px) {
            .main {
                flex-direction: column
            }

            iframe#mapFrame {
                height: 300px
            }

            .photo-wrap {
                aspect-ratio: 1/1;
                max-height: 320px
            }
        }
    </style>
</head>

<body>
    <div class="page-overlay">
        <div class="container">
            <div class="header">
                <img src="/images/logo.png" class="logo" alt="logo" />
                <div>
                    <h2 style="margin:0">JNTUK Kakinada — Track My Roots</h2>
                    <div style="color:#475569;font-size:13px">Digital Tree Tracking System</div>
                </div>
            </div>

            <div class="search-row" style="max-width:820px">
                <input id="treeInput" placeholder="Search by Tree ID or Name" autocomplete="off" />
                <button id="locateBtn">Locate</button>
                <div id="suggestions" class="suggestions" role="listbox"></div>
            </div>

            <div class="main">
                <div class="map-panel">
                    <h3 style="margin:0 0 8px 0">Location Preview</h3>
                    <iframe id="mapFrame" title="map preview" src=""></iframe>
                </div>

                <aside class="details">
                    <h3 style="margin:0 0 8px 0">Plant Details</h3>

                    <div class="photo-wrap" id="photoWrap">
                        <img id="plantPhoto" src="" alt="plant photo" style="display:none" />
                        <div id="noPhoto" class="no-photo" style="display:none">No photo available</div>
                    </div>

                    <div class="info-row"><strong>ID:</strong> <span id="infoId">—</span></div>
                    <div class="info-row"><strong>Name:</strong> <span id="infoName">—</span></div>
                    <div class="info-row"><strong>Planted Year:</strong> <span id="infoYear">—</span></div>
                    <div class="info-row"><strong>Maintained by:</strong> <span id="infoMaintainer">—</span></div>
                    <div class="info-row"><strong>Email:</strong> <span id="infoEmail">—</span></div>

                    <!-- reference + button -->
                    <div id="refBlock" class="ref-block" aria-hidden="true">
                        <span id="distanceOnly"></span>
                        <a id="routeBtn" class="route-btn" href="#" target="_blank" rel="noreferrer"
                            style="display:none">Show route</a>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        function normalizeKey(k) { return String(k || "").trim().toLowerCase().replace(/\s+/g, '_'); }

        function dmsToDecimal(str) {
            if (!str) return null;
            str = String(str).replace(/[^\d.,NSEW°'"\s-]/g, ' ').trim();
            if (str.indexOf(',') !== -1) {
                const parts = str.split(',');
                if (parts.length >= 2) {
                    const a = parseFloat(parts[0].replace(/[^\d\.\-]/g, '')), b = parseFloat(parts[1].replace(/[^\d\.\-]/g, ''));
                    if (!isNaN(a) && !isNaN(b)) return { lat: a, lng: b };
                }
            }
            const nums = str.match(/-?\d+(\.\d+)?/g);
            if (nums && nums.length >= 2) return { lat: parseFloat(nums[0]), lng: parseFloat(nums[1]) };
            return null;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            lat1 = Number(lat1); lon1 = Number(lon1); lat2 = Number(lat2); lon2 = Number(lon2);
            if ([lat1, lon1, lat2, lon2].some(x => isNaN(x))) return null;
            const toRad = d => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        let PLANTS = [], SUGGESTIONS = [];

        Papa.parse("trees.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function (res) {
                const rows = res.data || [];
                PLANTS = rows.map(row => {
                    const norm = {};
                    for (let k in row) norm[normalizeKey(k)] = row[k];
                    let gps = norm.gps_coordinate || norm.gps || norm.coords || "";
                    let lat = '', lng = '';
                    if (String(gps).indexOf(',') !== -1) { const p = String(gps).split(','); lat = p[0].trim(); lng = p[1].trim(); }
                    const ref = dmsToDecimal(norm.reference_point);
                    const photo = (norm.photo || norm.photo_url || '').toString().trim();
                    return {
                        id: (norm.tree_id || norm.id || '').toString().trim(),
                        name: (norm.tree_name || norm.name || '').toString().trim(),
                        lat, lng, photo,
                        planted_year: norm.planted_year || norm.year || '',
                        maintainer: { name: norm.maintained_by || norm.maintainer || '', email: norm.email_id || norm.email || '' },
                        reference: { name: norm.department_name || norm.department || '', lat: ref ? ref.lat : '', lng: ref ? ref.lng : '' }
                    };
                });

                SUGGESTIONS = PLANTS.map(p => ({ label: (p.id ? ('[' + p.id + '] ': '') + p.name : p.name), lower: ((p.id || '') + ' ' + (p.name || '')).toLowerCase(), id: p.id, name: p.name }));
        console.log('Loaded', PLANTS.length, 'rows');
    }
  });

        const inputEl = document.getElementById('treeInput');
        const suggestionsEl = document.getElementById('suggestions');

        inputEl.addEventListener('input', () => {
            const q = String(inputEl.value || '').trim().toLowerCase();
            if (!q) { suggestionsEl.style.display = 'none'; return; }
            const results = SUGGESTIONS.filter(s => s.lower.indexOf(q) !== -1).slice(0, 20);
            if (!results.length) { suggestionsEl.style.display = 'none'; return; }
            suggestionsEl.innerHTML = results.map((r, i) => `<div class="suggestion-item" data-i="${i}">${r.label}</div>`).join('');
            suggestionsEl.style.display = 'block';
        });

        suggestionsEl.addEventListener('click', (e) => {
            const item = e.target.closest('.suggestion-item');
            if (!item) return;
            const i = Number(item.getAttribute('data-i'));
            const s = SUGGESTIONS[i];
            inputEl.value = s.id || s.name || '';
            suggestionsEl.style.display = 'none';
            lookupTree();
        });

        document.addEventListener('click', (e) => { if (!e.target.closest('.search-row')) suggestionsEl.style.display = 'none'; });

        document.getElementById('locateBtn').addEventListener('click', lookupTree);
        inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); lookupTree(); } });

        function lookupTree() {
            const q = String(inputEl.value || '').trim().toLowerCase();
            if (!q) { alert('Enter Tree ID or Name'); return; }
            const rec = PLANTS.find(r => (r.id || '').toLowerCase() === q) || PLANTS.find(r => (r.name || '').toLowerCase() === q) || PLANTS.find(r => (r.name || '').toLowerCase().includes(q));
            if (!rec) { alert('Not found'); return; }
            showRecord(rec);
        }

        function showRecord(rec) {
            // map preview
            const mapFrame = document.getElementById('mapFrame');
            if (rec.lat && rec.lng) mapFrame.src = `https://www.google.com/maps?q=${rec.lat},${rec.lng}&z=18&output=embed`;
            else mapFrame.src = '';

            // info fields
            document.getElementById('infoId').textContent = rec.id || '—';
            document.getElementById('infoName').textContent = rec.name || '—';
            document.getElementById('infoYear').textContent = rec.planted_year || '—';
            document.getElementById('infoMaintainer').textContent = rec.maintainer?.name || '—';
            document.getElementById('infoEmail').textContent = rec.maintainer?.email || '—';

            // photo handling (square container + show whole image)
            const photoWrap = document.getElementById('photoWrap');
            const imgEl = document.getElementById('plantPhoto');
            const noPhoto = document.getElementById('noPhoto');

            if (rec.photo && rec.photo.trim() !== '') {
                imgEl.onerror = () => { console.error('Image failed:', rec.photo); imgEl.style.display = 'none'; noPhoto.style.display = 'flex'; };
                imgEl.onload = () => { imgEl.style.display = 'block'; noPhoto.style.display = 'none'; };
                imgEl.src = rec.photo;
                // ensure wrapper shows
                photoWrap.style.display = 'flex';
            } else {
                imgEl.src = '';
                imgEl.style.display = 'none';
                noPhoto.style.display = 'flex';
            }

            // reference & route button
            const refBlock = document.getElementById('refBlock');
            const distEl = document.getElementById('distanceOnly');
            const routeBtn = document.getElementById('routeBtn');

            if (rec.reference && rec.reference.name && rec.reference.lat && rec.reference.lng && rec.lat && rec.lng) {
                const d = haversine(Number(rec.lat), Number(rec.lng), Number(rec.reference.lat), Number(rec.reference.lng));
                const distStr = d === null ? 'unknown distance' : (d < 1000 ? `${Math.round(d)} m` : `${(d / 1000).toFixed(2)} km`);
                distEl.textContent = `Located ${distStr} from ${rec.reference.name}`;

                // Build Google Maps directions URL (origin = reference, destination = tree)
                const origin = `${rec.reference.lat},${rec.reference.lng}`;
                const destination = `${rec.lat},${rec.lng}`;
                // api=1 directions link
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=walking`;
                routeBtn.href = mapsUrl;
                routeBtn.style.display = 'inline-block';
                refBlock.style.display = 'flex';
            } else {
                refBlock.style.display = 'none';
                routeBtn.style.display = 'none';
            }
        }
    </script>
</body>

</html>